<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Control - Recreo</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Nunito', sans-serif; background: #f0f4f8; min-height: 100vh; padding: 24px 16px; }
  .header { text-align: center; margin-bottom: 36px; }
  .header h1 { font-family: 'Fredoka One', cursive; font-size: 2.6rem; color: #1a1a2e; margin-bottom: 6px; }
  .header p { color: #888; font-size: 15px; }
  .section-title { font-family: 'Fredoka One', cursive; font-size: 1.4rem; color: #1a1a2e; margin-bottom: 16px; }
  .qr-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 700px; margin: 0 auto 40px; }
  .qr-card { background: white; border-radius: 24px; padding: 28px 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
  .qr-card h3 { font-family: 'Fredoka One', cursive; font-size: 1.5rem; margin-bottom: 16px; }
  .qr-card.a h3 { color: #f7971e; }
  .qr-card.b h3 { color: #11998e; }
  .qr-wrapper { display: inline-block; padding: 12px; border-radius: 12px; background: white; border: 3px solid; margin-bottom: 12px; }
  .qr-card.a .qr-wrapper { border-color: #ffd200; }
  .qr-card.b .qr-wrapper { border-color: #38ef7d; }
  .qr-label { font-size: 12px; color: #aaa; margin-top: 8px; }
  .qr-url { font-size: 10px; color: #ccc; margin-top: 4px; word-break: break-all; padding: 0 8px; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 14px; max-width: 900px; margin: 0 auto 40px; }
  .stat-card { background: white; border-radius: 18px; padding: 20px 16px; text-align: center; box-shadow: 0 4px 16px rgba(0,0,0,0.07); }
  .stat-emoji { font-size: 32px; margin-bottom: 8px; }
  .stat-value { font-family: 'Fredoka One', cursive; font-size: 2rem; color: #1a1a2e; }
  .stat-label { font-size: 12px; color: #999; font-weight: 600; margin-top: 2px; }
  .table-section { max-width: 900px; margin: 0 auto; background: white; border-radius: 24px; padding: 28px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
  .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
  .btn-refresh { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 12px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
  .btn-clear { background: #fee2e2; color: #dc2626; border: none; padding: 10px 20px; border-radius: 12px; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 14px; cursor: pointer; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #999; padding: 8px 12px; border-bottom: 2px solid #f0f0f0; }
  td { padding: 14px 12px; border-bottom: 1px solid #f8f8f8; font-size: 14px; font-weight: 600; color: #333; }
  tr:last-child td { border-bottom: none; }
  .badge-grado { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
  .badge-8 { background: #ffd20020; color: #d97706; }
  .badge-9 { background: #38ef7d20; color: #059669; }
  .badge-estado { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
  .bueno { background: #dcfce7; color: #16a34a; }
  .malo { background: #fee2e2; color: #dc2626; }
  .empty-state { text-align: center; padding: 40px; color: #bbb; }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .auto-badge { display: inline-block; background: #dcfce7; color: #16a34a; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px; margin-left: 8px; vertical-align: middle; }
  .status-bar { max-width: 900px; margin: 0 auto 10px; text-align: right; font-size: 12px; color: #aaa; }
  @media (max-width: 480px) { .qr-section { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div class="header">
  <h1>üè´ Panel de Control</h1>
  <p>Sistema de pr√©stamo de objetos deportivos ¬∑ Recreo 9:30‚Äì9:55 AM
    <span class="auto-badge">‚óè Auto-actualiza</span>
  </p>
</div>

<div style="max-width:700px;margin:0 auto 12px;">
  <div class="section-title">üì± C√≥digos QR por Grado</div>
</div>
<div class="qr-section">
  <div class="qr-card a">
    <h3>8¬∞ Grado</h3>
    <div class="qr-wrapper"><div id="qr-8"></div></div>
    <div class="qr-label">Escanear para registrar</div>
    <div class="qr-url" id="url-8"></div>
  </div>
  <div class="qr-card b">
    <h3>9¬∞ Grado</h3>
    <div class="qr-wrapper"><div id="qr-9"></div></div>
    <div class="qr-label">Escanear para registrar</div>
    <div class="qr-url" id="url-9"></div>
  </div>
</div>

<div style="max-width:900px;margin:0 auto 12px;">
  <div class="section-title">üìä Resumen del D√≠a</div>
</div>
<div class="stats-grid">
  <div class="stat-card"><div class="stat-emoji">üìã</div><div class="stat-value" id="total-reg">0</div><div class="stat-label">Total Registros</div></div>
  <div class="stat-card"><div class="stat-emoji">‚öΩ</div><div class="stat-value" id="fut-count">0</div><div class="stat-label">Pelota F√∫tbol</div></div>
  <div class="stat-card"><div class="stat-emoji">üèê</div><div class="stat-value" id="voll-count">0</div><div class="stat-label">Volleyball</div></div>
  <div class="stat-card"><div class="stat-emoji">ü™¢</div><div class="stat-value" id="cuerda-count">0</div><div class="stat-label">Salta Cuerdas</div></div>
  <div class="stat-card"><div class="stat-emoji">üé≤</div><div class="stat-value" id="mesa-count">0</div><div class="stat-label">Juego de Mesa</div></div>
  <div class="stat-card"><div class="stat-emoji">‚ö†Ô∏è</div><div class="stat-value" id="malo-count">0</div><div class="stat-label">Mal Estado</div></div>
</div>

<div class="status-bar" id="status-bar">Cargando...</div>
<div class="table-section">
  <div class="table-header">
    <div class="section-title" style="margin:0">üìù Registros</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn-refresh" onclick="loadData()">üîÑ Actualizar</button>
      <button class="btn-clear" onclick="clearData()">üóë Limpiar Todo</button>
    </div>
  </div>
  <div id="table-container">
    <div class="empty-state"><div class="icon">üì≠</div><p>No hay registros a√∫n.<br>Escanea un QR para empezar.</p></div>
  </div>
</div>

<script>
  // URLs de los formularios
  const currentUrl = window.location.href;
  const baseUrl = currentUrl.includes('/') ? currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1) : './';
  const url8 = baseUrl + 'grado_8.html';
  const url9 = baseUrl + 'grado_9.html';

  document.getElementById('url-8').textContent = url8;
  document.getElementById('url-9').textContent = url9;

  // Generar QR codes
  try {
    new QRCode(document.getElementById('qr-8'), { text: url8, width: 140, height: 140, colorDark: '#f7971e', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
  } catch(e) { document.getElementById('qr-8').innerHTML = '<p style="color:#f7971e;font-size:12px;">Sube los archivos en l√≠nea para ver el QR</p>'; }

  try {
    new QRCode(document.getElementById('qr-9'), { text: url9, width: 140, height: 140, colorDark: '#11998e', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
  } catch(e) { document.getElementById('qr-9').innerHTML = '<p style="color:#11998e;font-size:12px;">Sube los archivos en l√≠nea para ver el QR</p>'; }

  let registros = [];

  async function loadData() {
    let fromStorage = false;

    // Intentar storage compartido de Claude
    try {
      if (window.storage) {
        const result = await window.storage.list('registro:', true);
        const keys = result?.keys || [];
        if (keys.length > 0) {
          registros = [];
          for (const key of keys) {
            try {
              const r = await window.storage.get(key, true);
              if (r?.value) registros.push(JSON.parse(r.value));
            } catch(e) {}
          }
          fromStorage = true;
        }
      }
    } catch(e) {}

    // Fallback: localStorage (funciona sin internet)
    if (!fromStorage) {
      try {
        registros = JSON.parse(localStorage.getItem('registros_recreo') || '[]');
      } catch(e) { registros = []; }
    }

    registros.sort((a, b) => b.timestamp - a.timestamp);
    renderTable();
    renderStats();

    const now = new Date().toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('status-bar').textContent = 'Actualizado: ' + now + ' ¬∑ ' + registros.length + ' registro(s)' + (fromStorage ? ' ¬∑ üåê En l√≠nea' : ' ¬∑ üíæ Local');
  }

  function renderStats() {
    document.getElementById('total-reg').textContent = registros.length;
    document.getElementById('fut-count').textContent = registros.filter(r => r.objeto === 'Pelota de F√∫tbol').length;
    document.getElementById('voll-count').textContent = registros.filter(r => r.objeto === 'Volleyball').length;
    document.getElementById('cuerda-count').textContent = registros.filter(r => r.objeto === 'Salta Cuerdas').length;
    document.getElementById('mesa-count').textContent = registros.filter(r => r.objeto === 'Juego de Mesa').length;
    document.getElementById('malo-count').textContent = registros.filter(r => r.estado === 'Mal estado').length;
  }

  function renderTable() {
    const container = document.getElementById('table-container');
    if (registros.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No hay registros a√∫n.<br>Escanea un QR para empezar.</p></div>';
      return;
    }
    const objEmoji = { 'Pelota de F√∫tbol': '‚öΩ', 'Volleyball': 'üèê', 'Salta Cuerdas': 'ü™¢', 'Juego de Mesa': 'üé≤' };
    const rows = registros.map(r => `
      <tr>
        <td><span class="badge-grado ${r.grado && r.grado.includes('8') ? 'badge-8' : 'badge-9'}">${r.grado || '‚Äî'}</span></td>
        <td>${objEmoji[r.objeto] || ''} ${r.objeto || '‚Äî'}</td>
        <td><span class="badge-estado ${r.estado === 'Buen estado' ? 'bueno' : 'malo'}">${r.estado || '‚Äî'}</span></td>
        <td>${r.hora || '‚Äî'}</td>
        <td>${r.fecha || '‚Äî'}</td>
      </tr>`).join('');
    container.innerHTML = `<table><thead><tr><th>Grado</th><th>Objeto</th><th>Estado</th><th>Hora</th><th>Fecha</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  async function clearData() {
    if (!confirm('¬øBorrar todos los registros?')) return;
    try {
      if (window.storage) {
        const result = await window.storage.list('registro:', true);
        for (const key of (result?.keys || [])) {
          try { await window.storage.delete(key, true); } catch(e) {}
        }
      }
    } catch(e) {}
    try { localStorage.removeItem('registros_recreo'); } catch(e) {}
    registros = [];
    renderTable();
    renderStats();
  }

  loadData();
  setInterval(loadData, 15000);
</script>

</body>
</html>
